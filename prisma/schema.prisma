// Prisma schema for DeckForge V2
// Database: Supabase PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Plan {
  FREE
  PRO
  ENTERPRISE
}

enum ProjectStatus {
  DRAFT
  GENERATING
  READY
  EDITING
  EXPORTED
}

enum ComponentCategory {
  TITLE       // Cover, section divider
  NARRATIVE   // Text-heavy
  DATA        // Charts, KPIs, metrics
  COMPARISON  // Before/after, vs
  PROCESS     // Flow, timeline
  FRAMEWORK   // SWOT, 2x2, pyramid
  VISUAL      // Image-heavy, diagrams
  TABLE       // Data tables
  CLOSING     // Thank you, contact
}

enum ComponentSource {
  CORE         // Hand-coded by us
  USER_UPLOAD  // Extracted from user's sample deck
  AI_GENERATED // Generated from description
  COMMUNITY    // Shared by other users
}

enum ExtractionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Models
model User {
  id               String      @id @default(uuid())
  email            String      @unique
  name             String?
  plan             Plan        @default(FREE)
  stripeCustomerId String?     @unique @map("stripe_customer_id")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  projects         Project[]
  brandKits        BrandKit[]
  components       Component[] @relation("CreatedComponents")

  @@map("users")
}

model BrandKit {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  colors    Json     // {primary, secondary, accent, text, bg, ...}
  fonts     Json     // {heading, body}
  logoUrl   String?  @map("logo_url")
  tone      String?  // formal, friendly, technical, executive
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  projects Project[]

  @@index([userId])
  @@map("brand_kits")
}

model Project {
  id             String        @id @default(uuid())
  userId         String        @map("user_id")
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  brandKitId     String?       @map("brand_kit_id")
  brandKit       BrandKit?     @relation(fields: [brandKitId], references: [id], onDelete: SetNull)
  title          String
  status         ProjectStatus @default(DRAFT)

  // Generation parameters
  parameters Json? // {tone, style, audience, slideCount, focus, ...}

  // Content pipeline
  inputContent   String? @db.Text @map("input_content") // Raw text/document content
  parsedContent  Json?   @map("parsed_content")          // Structured extraction from Claude
  slideBlueprint Json?   @map("slide_blueprint")         // [{componentId, data, position}]

  // Outputs
  pptxUrl    String? @map("pptx_url") // Supabase Storage URL
  thumbnails Json?   // Slide preview URLs

  // Editing
  chatHistory Json? @map("chat_history") // [{role, message, timestamp}]
  editHistory Json? @map("edit_history") // Version history for undo/redo

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  slides Slide[]

  @@index([userId, status])
  @@index([createdAt])
  @@map("projects")
}

model Slide {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  position    Int
  componentId String   @map("component_id")
  component   Component @relation(fields: [componentId], references: [id])
  data        Json      // Data fed to component
  imageUrls   Json?     @map("image_urls") // AI-generated images
  notes       String?   @db.Text // Speaker notes
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@unique([projectId, position])
  @@index([projectId])
  @@map("slides")
}

// THE KEY MODEL - Dynamic Component Library
model Component {
  id           String            @id @default(uuid())

  // Metadata
  name         String
  description  String            @db.Text
  category     ComponentCategory
  tags         String[]          // For AI matching

  // Visual
  thumbnailUrl String?           @map("thumbnail_url")
  previewData  Json?             @map("preview_data") // Sample data for preview

  // Rendering
  renderCode String @db.Text     @map("render_code") // PptxGenJS render function
  dataSchema Json               @map("data_schema") // Expected input shape (JSON Schema)

  // Provenance
  source        ComponentSource
  createdBy     String?          @map("created_by") // userId if user-generated
  creator       User?            @relation("CreatedComponents", fields: [createdBy], references: [id], onDelete: SetNull)
  extractedFrom String?          @map("extracted_from") // projectId if auto-extracted

  // Sharing
  isPublic   Boolean @default(true) @map("is_public")
  popularity Int     @default(0) // Usage count
  rating     Float?              // User ratings (future)

  // AI Matching
  useCases String[] @map("use_cases") // When to use this component
  bestFor  String   @db.Text @map("best_for") // Short description

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  slides Slide[]

  @@index([category, isPublic])
  @@index([popularity])
  @@index([createdBy])
  @@map("components")
}

model ComponentExtraction {
  id                  String            @id @default(uuid())
  projectId           String            @map("project_id")
  status              ExtractionStatus  @default(PENDING)
  sampleDeckUrl       String            @map("sample_deck_url")
  extractedComponents Json?             @map("extracted_components") // [{name, description, renderCode}]
  error               String?           @db.Text
  createdAt           DateTime          @default(now()) @map("created_at")
  completedAt         DateTime?         @map("completed_at")

  @@index([status])
  @@map("component_extractions")
}
